def walk(grid, w, h, init)
  energized = {}
  done = {}
  queue = [init]

  while !queue.empty?
    x, y, d = queue.shift

    loop do
      if done.include? [x, y, d]
        break
      end

      energized[[x, y]] = true 
      done[[x, y, d]] = true

      case grid[y][x]
      when '.'
        case d
        when 0
          if y == 0
            break
          end
          y -= 1
        when 1
          if x == w - 1
            break
          end
          x += 1
        when 2
          if y == h - 1
            break
          end
          y += 1
        when 3
          if x == 0
            break
          end
          x -= 1
        end
      when '\\'
        case d
        when 0
          if x == 0
            break
          end
          x -= 1
          d = 3
        when 1
          if y == h - 1
            break
          end
          y += 1
          d = 2
        when 2
          if x == w - 1
            break
          end
          x += 1
          d = 1
        when 3
          if y == 0
            break
          end
          y -= 1
          d = 0
        end
      when '/'
        case d
        when 0
          if x == w - 1
            break
          end
          x += 1
          d = 1
        when 1
          if y == 0
            break
          end
          y -= 1
          d = 0
        when 2
          if x == 0
            break
          end
          x -= 1
          d = 3
        when 3
          if y == h - 1
            break
          end
          y += 1
          d = 2
        end
      when '-'
        case d
        when 1
          if x == w - 1
            break
          end
          x += 1
        when 3
          if x == 0
            break
          end
          x -= 1
        else
          if x < w - 1
            queue << [x + 1, y, 1]
          end
          if x == 0
            break
          end
          x -= 1
          d = 3
        end
      when '|'
        case d
        when 0
          if y == 0
            break
          end
          y -= 1
        when 2
          if y == h - 1
            break
          end
          y += 1
        else
          if y < h - 1
            queue << [x, y + 1, 2]
          end
          if y == 0
            break
          end
          y -= 1
          d = 0
        end
      end
    end
  end

  energized.length
end

def solve(input)
  grid = input.split("\n")
  w, h = grid[0].length, grid.length

  p walk(grid, w, h, [0, 0, 1])

  p [
    *((0...w).map { |x| [x, 0, 2] }),
    *((0...h).map { |y| [0, y, 1] }),
    *((0...w).map { |x| [x, h - 1, 0] }),
    *((0...h).map { |y| [w - 1, y, 3] }),
  ].map { |init| walk(grid, w, h, init) }.max
end

TEST = <<~EOF
.|...\\....
|.-.\\.....
.....|-...
........|.
..........
.........\\
..../.\\\\..
.-.-/..|..
.|....-|.\\
..//.|....
EOF

solve TEST

INPUT = <<~EOF
\\........../......................\\.....-.....................................|........|..|...................
.....\\..........\\-...|...........-..../...|..................\\......\\.|...\\............................../....
..\\..-...|........-............./..............-........\\\\................/....-........\\.....................
........../-/\\...........-...-.../..-.../.....\\.....-..................-..............\\...-................-..
...............|..-.......-.........\\..../........./............/..........|..|\\/...................-..-......
../....\\/-.....................|................................|...|..\\............../........-........\\\\....
.................-..../..../....\\........../.......|............-....................../....|............\\....
...................................../....\\...\\........-../................../................\\....-..........
..................\\.....|.............................|.................................\\.....................
./...-.........-............\\...............|....|........\\...................\\............|\\.../......\\......
.|........-./............/...\\.......................-......../|../-..........................-....|..........
......................................-...-.........................-.|.......................................
.\\..-............/..........//...-...-\\..........................\\.................|/.................../|....
...-....-../..../..\\............./\\......../.\\...././.......\\\\....\\...........-..\\.........|./.../...|-...../.
.............|..-.............-...-\\.\\...........\\.\\...............................-................|.........
../....-..-...../\\....../............\\-.........-......|..-.............................-.....................
|...........\\.........|......./............|..............-.........\\.......-.....|........../.........-......
....|...|\\...............\\.........|........|......-\\./.........-......../-..............|.../............|\\..
................|.................................................|./......|..............|...................
.......-...............................\\.......-.................-...|.........../.....................\\......
...\\.|...-............................................\\....................|...\\.......................|......
-......../..../....|......-\\.........................................../../....|...|....\\./..../........\\..../
........|........../..-/......................|......-.......-........\\...............\\.\\.....................
..............\\........|...............................|............./......\\...|...\\..........-............|.
..............|......../.......-..........\\.\\..../...\\..........-.........|.....\\...............|.............
-.........../........./....\\....-.-./../......|............................\\................/........-\\.......
.....-.....\\........................../..../.........................|.....-...|......\\....|.|................
.....\\............./.......-/........../...-.\\........................./........-.....|................|......
..\\......-\\-...-..................../................../.......\\.......|........../............|..............
.......|..................|......................../........\\..-.................|......../................-.|
...........-................./.\\....../........|......./.....\\........\\....|.........\\..........|.....|.......
.....-........\\.......|......../......|....-|.|..-...............|....-.\\.../.......--.../....................
....................................-.../..|.................\\\\..\\............................|....|..........
./..|................................|.....-/................................../....../.....-.......|......|..
.|........../.......|.\\....................../..\\..........-\\...../...................|................./.....
.............../.-|......./.......-.....................\\....../...........-../...............................
.......-.........|...../........|.-...|..................|.........|......\\|....\\.......................\\.-.-.
..\\.../......../....\\.........../....\\-........../...-..\\\\........-.....\\..\\...........--.....................
.........\\....../................|.........................|................./...../.........-............-...
....\\.-.\\....|..|.........|.....|....\\..|...-.....-\\.............|....\\.......././...|..\\....-...............-
..../..\\.\\./......./.....................-.-............\\.|..-........./...........\\.|.......-..-..-.......-..
.............../...-../\\........|..//....\\..../..-...........................\\......................./......./
...........\\.............\\............................|.../..........-............\\......\\....\\.\\.|...|....-..
..../.....|\\................................\\........................................\\.......\\..............\\.
..|......\\.\\...-.....................-............|\\....\\............-........................................
........\\.-........................../..........|...|............................/..\\...................//....
....-....../......../.................\\.....|.............................\\..../..........-......-............
..\\../...\\.................|.....|.\\.\\........-........|......./\\.......-......./....................-........
..\\|..............-.........../..-.....................|.../...............................||...........-.....
.....|......|..\\.....\\.........|\\/|......................-./.../...........\\......-..-........................
..........|..................|............/........\\.....-........./|.............-.../........|......\\.......
......./.........\\................................\\.....-...-...................-...../.....-.|......\\........
............................/|......../.....-...|\\............\\...-......|............................-.......
...................|\\.../...........|..........|../...|...|\\................\\......../........../..|\\........|
/.....|-..\\............................\\...../\\......-......\\....\\....-...........-\\.......\\..|...............
..-.............-../....../.-......../....|............//......|.....-........................................
.......\\...../...../.............../.............-.........../................................./..............
...-........../.........../..............\\........................../................|...................|....
\\.\\.............\\...-......\\..../.........|..../.\\.......................|.....................\\.-.-.|..../...
...-.-/.\\.../../......./............-......|.|.../.-....\\...-../....\\..-........-.............................
..........|....-..-..-..\\./..-../\\....\\....|..\\.../...|...\\..\\....................-..............|............
/................./............/......\\..../......-................/..-/.../................................-.
.....|.....-..\\......-.|............................|\\.\\............\\........................-........-.\\.....
............\\..\\....\\...........-..............................|...\\.........|..../\\...-...-................./
.....................|......../.............../.|-......................-|.....|..................-...........
..\\.......-........|.|..........\\...................|...............................-...|..............\\......
....................\\........-..../...\\......................|.....-...../..............|........-...-........
\\-........-.|...-.|.-....|.................-......................|..............................\\............
....../-.....//...||...........-...../...|......-....|.-...........-|..|.../..-....-...............-..........
...........\\..\\....................-...........|...-..........\\.....-............................/....-.......
............................../............-.......|.........../............................-.................
...................|............../..................../..../...............\\|.........-.............\\........
.-.\\....................|...............\\..................\\.........................................|....\\...
....................................-..|.............-.........-..-....../....\\........................-.....|
.....\\.....-.............--.............\\...................................................-..............-..
./......-....................../.....|.../...........\\.........../..........................|.................
...........................|.............|..\\.-........./..-............../.............\\...-..|......../.....
....-.............................|.......-.............../...../..........\\........\\........../..............
.................-/-.-.....-.............................\\....\\.....-......|.....\\....../.....................
......-...................|...............\\...............................................|.............../...
...............-............-................./..../..................../...............|..../.....-..........
........||...........|......\\............/........\\...|.............../...../......|......................|...
......../.\\.............\\..........\\.........\\.......\\.../.......\\........../|....|...../.|......|..|......|..
........\\.../|........\\.................|.......-...-......|.\\.........................\\...........|......|...
....|.......|..-...........-...../-......\\...................|.............../\\.....\\..........|....-.\\\\...-..
..............-......\\.........|..........|..................|..||.-..............//.\\..\\.-.......\\.........|.
............./|....|.-...........-.......|........../.../.....................|...-.......\\....|..../.........
.\\...\\./-...........................................\\...............\\....|......\\......-......................
....|...........|................../.\\.|.........-./\\...\\............-........-.....\\..........|........../...
.../.|................/..........-.\\.-.....\\..-.............................................................|.
.........|..............|.....-..........\\|.........\\.|.....................|...........-...|...-|.|......-...
.-......................\\-.|......./..-.....|.|.......-.............|...................|.............|.....-.
./../............|........./............................\\..........|.-................../.......|..\\\\.........
........-................................-.........-......./......./......\\......./..|............./..........
./.............|.........../..-\\............|/..........|.......-..-.............................-............
............................./......-.-.......|...\\...................\\...................................|...
......\\...................-...\\........\\............-..|...................-..........\\.../................-..
........|......|.........-...\\....................\\.............\\-......|..........-......../.....\\\\-......../
..................\\......./............................./...|.\\....................................\\......\\...
..\\........./..........................-......\\.........................\\........-/../.-.|-.........\\|.......|
-............-...........-.........-.........|..........\\-.-..../...../-.../.../...../........................
-.................|................-.....|.../......................\\.....................|......\\............
.........................................\\....-..........\\.....................--..-..............|.../.\\.....
.../.........-.......................-................\\...............\\........|..........\\|.........|..\\.....
............./....\\./......................../...\\...........................\\...-....\\........../....../.....
.......|..../../.|..............-.\\............|../............|..\\......................|\\............-../...
....\\....../.........-.-.........|....\\........................-/........................................../..
.................|......................-..........\\\\............................/...\\........................
.....\\.......-..........-./../............|.........|./...|...........|...|......|.-......../.................
./.............-/.........|........../.............\\.......-......................../.../....\\...\\\\...\\..-....
EOF

solve INPUT
