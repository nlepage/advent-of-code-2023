require 'set'

EXPANSION_PART1 = 1
EXPANSION_PART2 = 999999

def solve(input)
  lines = input.split("\n")
  h, w = lines.length, lines.first.length
  galaxies = lines.flat_map.with_index { |line, y| line.each_char.with_index.filter { |c, x| c=='#' }.map { |c, x| [y, x] } }

  gys = Set[*galaxies.map { |y, x| y }]
  gxs = Set[*galaxies.map { |y, x| x }]

  (0...h).reverse_each.filter { |y| !gys.include? y }.each { |y| galaxies.filter { |gy, gx| gy > y }.each { |g| g[0] += EXPANSION_PART2 } }
  (0...w).reverse_each.filter { |x| !gxs.include? x }.each { |x| galaxies.filter { |gy, gx| gx > x }.each { |g| g[1] += EXPANSION_PART2 } }

  p galaxies.flat_map.with_index { |g1, i| galaxies[(i+1)..].map { |g2| g2[0]-g1[0] + (g2[1]-g1[1]).abs } }.sum
end

TEST = <<~EOF
...#......
.......#..
#.........
..........
......#...
.#........
.........#
..........
.......#..
#...#.....
EOF

solve TEST

INPUT = <<~EOF
............#..................#..........................................................#..........................#......................
.................................................................#...............#..............#...............#......................#....
...................................#.....................#..................#............................#...................#..............
#.....................#.....................#...............................................................................................
........................................................................................#............#......................................
.....#..............................................#.......................................................................................
.......................................#................................#..........#...........#......................................#.....
..................#...........#.............................................................................................................
.............................................#............#.................................................................................
.#............................................................................#..................................#..........................
............#......................#....................................................................#...................#.............#.
.......#............#....................#........#...................................#......................#..............................
...................................................................#................................#.......................................
..............................#.................................................................................................#...........
..#...........................................................................................#.......................#.....................
..............................................................................#.............................................................
.......................................#.........#............#...........................#................#..............................#.
........................................................#.............#.....................................................................
.....#..........................#....................................................................#....................#.................
....................#.......................#...................................#...............#...............#......................#....
...............#..................................................................................................................#.........
..#......................................................................#...................................................#..............
.................................................#............#.........................................#.............#.....................
....................................#.......................................................................................................
...........#..........................................................................#.....................................................
.................#..........................................................................................................................
.............................................#............................#....................................................#............
.........................#.......#..........................#...............................................................................
.......#............#....................................................................................................#..........#.......
...................................................................#................#...........................#...........................
..............#....................................#..........................#..............#..............................................
..#....................#....................................................................................#........#......................
.........................................................................#......................................................#...........
......................................#.........#...........................................................................................
..........#.................................................................................................................................
.....................#......................#...............#.................................................#.............................
...............................#...................................................#....................................#.................#.
.............................................................................................#..............................................
...................................................................#........................................................................
................#..........#.....................#..................................................................................#.......
...................................#............................................#..................#........................................
.....#.....................................................................#...............................#.....#..........................
............#.........................................................................................................#.....................
.....................#.............................#.......................................................................#................
..............................................................#...............................#..........................................#..
.....................................#.......#.................................................................#............................
...............#...................................................................#.....#..............................#...................
...#.....................#.........................................#......#...........................#.....................................
.........#......................................................................................#.............................#.............
..........................................................#.................................................................................
..................................#.......#...........................................#......................#......................#.......
.............................................................................#..............................................................
.....#...........................................#..................................................#....................#..................
............................................................................................................................................
............................................................................................................................................
.................#...................#........................#......#..................................#...................................
..........................#.........................#.....................................#......#.........................#................
..............................................#...........................#.....................................#...........................
#.....................#.................#............................................................................................#......
...............................#..........................#.....................................................................#...........
..........#.........................#.............................#...........#....................................#........................
.....................................................#......................................................................................
.............................................................................................#..............................................
............................................................................................................................................
...............#...........#..........#.....#..................#.......................#......................#.......#..............#......
........#...........#.............................#.....#...................................................................................
............................................................................................................................................
.#................................#.............................................#................................................#..........
............................................................................................................................................
..........................................................................#...............................................................#.
..............................#...............#......................................#........#.............#.........#.....................
...#................................................#.......................................................................................
............................................................................................................................................
.......................#...............#...........................................................#..........................#.............
.................................................#...........#......................................................#.......................
...........#............................................................................#...................................................
.....#..................................................#.....................................#.............#..............................#
..................#..........#..............................................#..........................#..............................#.....
....................................................#.......................................................................................
..#............................................................................................................#................#...........
.............................................................#........#..........#.....#....................................................
...........#..........#............#.......#...............................................................................#................
............................................................................................................................................
......................................................#..............................................#......................................
.........................#.....#...............................................#................................#................#..........
...#.......................................................................................................#...........................#....
........#...........................#....................................#...............#..................................................
..........................................#.......................#.........................................................................
............................................................#.............................................................#.................
...........................#...................................................................#.....................#......................
...............#.................#............#.............................................................................................
...#......#..........................................#..................................#...............#...................................
.................................................................#......................................................................#...
.......................#..................#...............#..................#..............................................................
.................................................#...................................#.............#............................#...........
................#...........................................................................................................................
...................................#.........................................................#........................#.............#.......
.............................................................#..........................#......................#............#..............#
...#..................#.............................#..........................#............................................................
........#......................................#............................................................................................
..............#............#...........#............................................................#.......................................
....................................................................#.......................#...............................................
.#....................................................................................#........................................#.......#....
...........#...................#............................................................................................................
.........................#..........#.......#.........#..................#..................................#...............................
................................................................#....................................................#......................
...#.............................................................................................#.....#....................................
.................................................#....................#.....................................................................
.......................#.........#..................................................#.......#...................#........#..................
........................................................................................................................................#...
...........#................................................#..............................................#................................
.....................................#..........................................................#...........................................
....#.......................................#....................................................................................#..........
...................#..............................................#.........#..........#.............#......................................
............................................................................................................................................
............................................................................................................................................
.............#.......................................#...............#......................#......................#...............#........
...............................................#............................................................................................
....#.................................#.......................................................................................#.............
............................#.................................................#......#.....................................................#
...................#..............#.......#...............#.....................................................#.........#.................
..................................................................#.....................................#...................................
...................................................#..............................#......#.......#..............................#...........
.......................................#.....................#..............#......................................#........................
.................#..........................................................................................................................
..............................................#.......#.................#.................................#.................................
.........#...............#.............................................................#.................................#.............#....
..#..............................#..................................#.......................................................................
...............................................................#...........#.......................................................#........
............................................................................................................................#...............
................#...........#............#.........#........................................................................................
........#.............#........................................................................................#...........................#
..........................................................#...............................#..............#...........................#......
...............................#................................................................#...........................................
..................#.............................................#.........#..........................................#......................
.....#................................................#.........................................................................#...........
............................................#.....................................#.........#...............................................
.......................................................................................................................................#....
#..........#.............#......#.................................#...................................#.....................................
.....................................#.........#.........................#.....#............................................................
EOF

solve INPUT
